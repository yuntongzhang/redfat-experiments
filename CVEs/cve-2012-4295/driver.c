/**
 * gcc -o driver -O2 driver.c
 * valgrind ./driver 10 10 80
 **/

#include <stdlib.h>
#include <string.h>
#include <stdio.h>

#define DECHAN_MAX_AUG_INDEX 4

typedef signed char gint8;
typedef unsigned char guint8;
typedef unsigned short guint16;

typedef struct sdh_g707_format_s
{
  guint8 m_sdh_line_rate;
  guint8 m_vc_size ;
    gint8 m_vc_index_array[DECHAN_MAX_AUG_INDEX];
        /* i = 4 --> ITU-T letter #E - index of AUG-64
         * i = 3 --> ITU-T letter #D - index of AUG-16
         * i = 2 --> ITU-T letter #C - index of AUG-4,
         * i = 1 --> ITU-T letter #B  -index of AUG-1
         * i = 0 --> ITU-T letter #A  - index of AU3*/
} sdh_g707_format_t;

static int
channelised_fill_sdh_g707_format(sdh_g707_format_t* in_fmt, guint16 bit_flds, guint8 vc_size, guint8 speed)
{
  int i = 0; /* i = 4 --> ITU-T letter #E - index of AUG-64
              * i = 3 --> ITU-T letter #D - index of AUG-16
              * i = 2 --> ITU-T letter #C - index of AUG-4,
              * i = 1 --> ITU-T letter #B  -index of AUG-1
              * i = 0 --> ITU-T letter #A  - index of AU3*/

  if (0 == vc_size)
  {
    /* unknown / unsed container size*/
    return -1;
  }
  in_fmt->m_vc_size = vc_size;
  in_fmt->m_sdh_line_rate = speed;
  memset(&(in_fmt->m_vc_index_array[0]), 0xff, DECHAN_MAX_AUG_INDEX);

  /* for STM64 traffic, start from #E index shoud be 0 */
  in_fmt->m_vc_index_array[ speed - 1] = 0;
  /* for STM64 traffic,from #D and so on .. */
    for (i = (speed - 2); i >= 0; i--)
  {
    guint8 aug_n_index = 0;

    /*if AUG-n is bigger than vc-size*/
    if ( i >= (vc_size - 1))
    {
      /* check the value in bit flds */
      aug_n_index = ((bit_flds >> (2 *i))& 0x3) +1;
    }
    else
    {
      aug_n_index = 0;
    }
    // remove this incremental error to reduce noise
    // in_fmt->m_vc_index_array[i] = aug_n_index;
    fprintf(stderr, "aug_n_index is %d\n", aug_n_index);
  }
  return 0;
}

int main(int argc, char** argv)
{
    sdh_g707_format_t *im = (sdh_g707_format_t *) malloc(sizeof(sdh_g707_format_t));
    guint16 dummy1;
    guint8 dummy2, speed;
    dummy1 = atoi(argv[1]);
    dummy2 = atoi(argv[2]);
    speed = atoi(argv[3]);
    int res;

    sdh_g707_format_t *buf = (sdh_g707_format_t *) malloc(sizeof(sdh_g707_format_t));
    // benign call to make malloc not optimized out
    res = channelised_fill_sdh_g707_format(buf, dummy1, dummy2, 3);
    fprintf(stderr, "Res #1 is %d\n", res);
    // buggy call
    res = channelised_fill_sdh_g707_format(im, dummy1, dummy2, speed);
    fprintf(stderr, "Res #2 is %d\n", res);
    return res;
}
